<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Results</title>

  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
</head>

<body>
  <div class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="dot"></div>
        <div>
          <h1>Results</h1>
          <p>Preview + customizable charts</p>
        </div>
      </div>

      <div class="pill">
        <span>Status:</span>
        <b>{{ "Ready" if not error else "Needs fixes" }}</b>
      </div>
    </header>

    <div class="grid">
      <!-- Preview -->
      <section class="card">
        <div class="cardHead">
          <h2>Data preview</h2>
          <p>First 20 rows so you can quickly confirm the upload.</p>
        </div>

        <div class="cardBody">
          {% if error %}
            <div class="errorBox">{{ error }}</div>
          {% endif %}

          {% if headers %}
            <div class="tableWrap">
              <table>
                <thead>
                  <tr>
                    {% for h in headers %}
                      <th>{{ h if h else "(blank)" }}</th>
                    {% endfor %}
                  </tr>
                </thead>
                <tbody>
                  {% for r in preview_rows %}
                    <tr>
                      {% for _ in headers %}
                        <td>{{ r[loop.index0] if loop.index0 < (r|length) else "" }}</td>
                      {% endfor %}
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          {% else %}
            <div class="empty">No preview available.</div>
          {% endif %}

          <div class="btnRow" style="margin-top:12px;">
            <button class="ghost" type="button" onclick="window.location.href='/'">Upload another</button>
          </div>
        </div>
      </section>

      <!-- Chart + Controls -->
      <section class="card">
        <div class="cardHead">
          <h2>Visualization</h2>
          <p>Pick chart type, X/Y columns, and aggregation. Updates instantly.</p>
        </div>

        <div class="cardBody">
          <div class="chartControls">
            <div class="control">
              <label>Chart type</label>
              <select id="chartType">
                <option value="bar" selected>Bar</option>
                <option value="line">Line</option>
                <option value="pie">Pie</option>
                <option value="doughnut">Doughnut</option>
                <option value="scatter">Scatter</option>
              </select>
            </div>

            <div class="control">
              <label>X column</label>
              <select id="xCol"></select>
            </div>

            <div class="control">
              <label>Y column</label>
              <select id="yCol"></select>
            </div>

            <div class="control">
              <label>Aggregation</label>
              <select id="agg">
                <option value="sum" selected>Sum</option>
                <option value="avg">Average</option>
                <option value="count">Count</option>
              </select>
            </div>

            <div class="control">
              <label>Top N (pie)</label>
              <select id="topN">
                <option value="5">5</option>
                <option value="8" selected>8</option>
                <option value="12">12</option>
                <option value="20">20</option>
              </select>
            </div>
          </div>

          <div class="chartCard" style="margin-top:12px;">
            <div class="chartTitle">
              <b id="chartTitle">Chart</b>
              <span id="chartHint">Customize above â€¢ Download below</span>
            </div>
            <canvas id="chart"></canvas>

            <div class="btnRow" style="margin-top:12px;">
              <button id="downloadBtn" type="button">Download PNG</button>
            </div>

            <div class="mutedLine" id="chartNote" style="margin-top:8px;"></div>
          </div>

          <!-- SAFE data injection -->
          <script>
            const HEADERS = {{ headers|tojson|safe }};
            const ROWS = {{ rows_json|tojson|safe }};
            const DEFAULT_X = {{ default_x|tojson|safe }};
            const DEFAULT_Y = {{ default_y|tojson|safe }};
          </script>

          <script>
            let chartInstance = null;

            const chartTypeEl = document.getElementById("chartType");
            const xColEl = document.getElementById("xCol");
            const yColEl = document.getElementById("yCol");
            const aggEl = document.getElementById("agg");
            const topNEl = document.getElementById("topN");
            const chartTitleEl = document.getElementById("chartTitle");
            const chartNoteEl = document.getElementById("chartNote");
            const downloadBtn = document.getElementById("downloadBtn");

            function isNumeric(v){
              if (v === null || v === undefined) return false;
              const s = String(v).trim();
              if (s === "") return false;
              const n = Number(s);
              return !Number.isNaN(n) && Number.isFinite(n);
            }

            function toNumber(v){
              const n = Number(String(v).trim());
              return (Number.isFinite(n) ? n : null);
            }

            function buildSelectOptions(selectEl, headers){
              selectEl.innerHTML = "";
              headers.forEach((h, idx) => {
                const opt = document.createElement("option");
                opt.value = String(idx);
                opt.textContent = h || `(Column ${idx+1})`;
                selectEl.appendChild(opt);
              });
            }

            function groupAggregate(rows, xIdx, yIdx, agg){
              // returns {labels:[], values:[], note:""}
              const map = new Map();

              for (const r of rows){
                const x = (r[xIdx] ?? "").toString().trim();
                if (x === "") continue;

                if (!map.has(x)) map.set(x, {sum:0, count:0});
                const bucket = map.get(x);

                if (agg === "count"){
                  bucket.count += 1;
                } else {
                  const y = toNumber(r[yIdx]);
                  if (y === null) continue;
                  bucket.sum += y;
                  bucket.count += 1;
                }
              }

              const labels = [];
              const values = [];

              for (const [k, v] of map.entries()){
                labels.push(k);
                if (agg === "count") values.push(v.count);
                else if (agg === "avg") values.push(v.count ? (v.sum / v.count) : 0);
                else values.push(v.sum);
              }

              // Sort descending by value for nicer charts
              const zipped = labels.map((l,i)=>({l, v: values[i]}))
                                   .sort((a,b)=>b.v - a.v);

              return {
                labels: zipped.map(z=>z.l),
                values: zipped.map(z=>z.v),
                note: `Grouped by X (${HEADERS[xIdx]}) with ${agg.toUpperCase()} on Y (${HEADERS[yIdx]}).`
              };
            }

            function buildScatter(rows, xIdx, yIdx){
              const points = [];
              for (const r of rows){
                const x = toNumber(r[xIdx]);
                const y = toNumber(r[yIdx]);
                if (x === null || y === null) continue;
                points.push({x, y});
              }
              return points;
            }

            function renderChart(){
              const type = chartTypeEl.value;
              const xIdx = Number(xColEl.value);
              const yIdx = Number(yColEl.value);
              const agg = aggEl.value;
              const topN = Number(topNEl.value);

              const xName = HEADERS[xIdx] || "X";
              const yName = HEADERS[yIdx] || "Y";

              const ctx = document.getElementById("chart");

              if (chartInstance){
                chartInstance.destroy();
                chartInstance = null;
              }

              chartNoteEl.textContent = "";

              if (type === "scatter"){
                const pts = buildScatter(ROWS, xIdx, yIdx);
                chartTitleEl.textContent = `Scatter: ${yName} vs ${xName}`;
                chartNoteEl.textContent = "Scatter uses raw numeric X and Y (no aggregation).";

                chartInstance = new Chart(ctx, {
                  type: "scatter",
                  data: {
                    datasets: [{
                      label: `${yName} vs ${xName}`,
                      data: pts
                    }]
                  },
                  options: {
                    responsive: true,
                    plugins: { legend: { display: true } }
                  }
                });
                return;
              }

              // For bar/line/pie/doughnut: grouped aggregation
              const grouped = groupAggregate(ROWS, xIdx, yIdx, agg);

              let labels = grouped.labels;
              let values = grouped.values;

              // For pie/doughnut: keep top N and lump rest as "Other"
              if (type === "pie" || type === "doughnut"){
                if (labels.length > topN){
                  const topLabels = labels.slice(0, topN);
                  const topValues = values.slice(0, topN);
                  const otherSum = values.slice(topN).reduce((a,b)=>a+b,0);
                  topLabels.push("Other");
                  topValues.push(otherSum);
                  labels = topLabels;
                  values = topValues;
                }
              }

              chartTitleEl.textContent = `${type.toUpperCase()}: ${yName} by ${xName}`;
              chartNoteEl.textContent = grouped.note;

              chartInstance = new Chart(ctx, {
                type: type,
                data: {
                  labels: labels,
                  datasets: [{
                    label: (agg === "count") ? `Count by ${xName}` : `${agg.toUpperCase()}(${yName})`,
                    data: values,
                    borderWidth: 1,
                    borderRadius: (type === "bar" ? 10 : 0),
                    tension: (type === "line" ? 0.35 : 0)
                  }]
                },
                options: {
                  responsive: true,
                  plugins: { legend: { display: true } }
                }
              });
            }

            // Init selects
            buildSelectOptions(xColEl, HEADERS);
            buildSelectOptions(yColEl, HEADERS);

            // Default selections
            xColEl.value = String(DEFAULT_X ?? 0);
            yColEl.value = String(DEFAULT_Y ?? Math.min(1, HEADERS.length-1));

            // UX: if chart is pie/doughnut, aggregation "count" often makes sense
            function syncControls(){
              const t = chartTypeEl.value;
              topNEl.disabled = !(t === "pie" || t === "doughnut");
            }

            // Listeners
            [chartTypeEl, xColEl, yColEl, aggEl, topNEl].forEach(el=>{
              el.addEventListener("change", ()=>{
                syncControls();
                renderChart();
              });
            });

            // Download
            downloadBtn.addEventListener("click", ()=>{
              if (!chartInstance) return;
              const a = document.createElement("a");
              a.href = chartInstance.toBase64Image();
              a.download = "chart.png";
              a.click();
            });

            // First render
            syncControls();
            renderChart();
          </script>
        </div>
      </section>
    </div>
  </div>
</body>
</html>
